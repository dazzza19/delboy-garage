<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üîß Del the Spanner</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #111; color: white; overflow: hidden; }
    #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; }
    .container { position: relative; z-index: 2; text-align: center; padding: 80px 20px 20px; }
    input, button { padding: 12px; margin: 8px; border: none; border-radius: 30px; font-size: 16px; }
    button { background: #f8d000; cursor: pointer; font-weight: bold; }
    .results { background: rgba(0,0,0,0.8); padding: 20px; border-radius: 12px; margin: 20px; text-align: left; }
    .video-link, .parts-link { color: #63d4ff; text-decoration: none; font-weight: bold; display: block; margin: 10px 0; }
    .parts-link { color: #a0e86a; }
  </style>
</head>
<body>

  <!-- 3D Canvas -->
  <div id="canvas"></div>

  <!-- UI -->
  <div class="container">
    <h1>üîß Del the Spanner üîß</h1>
    <p>"Proper 'andy, innit?"</p>

    <input type="text" id="make" placeholder="Make (e.g. Ford)" />
    <input type="text" id="model" placeholder="Model (e.g. Focus)" />
    <input type="number" id="year" placeholder="Year" min="1980" max="2025" />
    <input type="text" id="symptom" placeholder="Symptom (e.g. brakes failed)" />
    <button onclick="diagnose()">Ask Del</button>

    <div class="results" id="results" style="display:none;">
      <h3>Possible Causes:</h3>
      <ul id="causes"></ul>
      <a id="video-link" target="_blank" class="video-link">üîç Watch Fix Video</a>
      <a id="amazon-link" target="_blank" class="parts-link">üõí Search Amazon</a>
      <a id="ebay-link" target="_blank" class="parts-link">üõ†Ô∏è Search eBay</a>
    </div>
  </div>

  <!-- ‚úÖ CORRECT THREE.JS + GLTFLoader (NO MODULE ERRORS) -->
  <script type="module">
    // ‚úÖ Use full CDN URLs (no bare imports)
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.155/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.155/examples/jsm/loaders/GLTFLoader.js';

    // === THREE.JS SETUP ===
    let scene, camera, renderer, avatar, mixer;

    window.addEventListener('load', () => {
      // Scene
      scene = new THREE.Scene();

      // üî• Garage Background
      const textureLoader = new THREE.TextureLoader();
      textureLoader.load(
        'https://images.unsplash.com/photo-1580281842412-a9bc59aaf4f1?auto=format&fit=crop&w=1920&q=80',
        (texture) => {
          scene.background = texture;
        }
      );

      // Camera
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 1.6, 3);

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('canvas').appendChild(renderer.domElement);

      // Lights
      scene.add(new THREE.AmbientLight(0xffffff, 0.7));
      const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
      dirLight.position.set(5, 10, 5);
      scene.add(dirLight);

      // Load 3D Model (Public Test Model)
      const loader = new GLTFLoader();
      const MODEL_URL = 'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/RobotExpressive.glb';

      loader.load(
        MODEL_URL,
        (gltf) => {
          avatar = gltf.scene;
          avatar.scale.set(1.2, 1.2, 1.2);
          avatar.position.set(0, 0, 0);
          scene.add(avatar);

          // Animation
          mixer = new THREE.AnimationMixer(avatar);
          if (gltf.animations.length > 0) {
            mixer.clipAction(gltf.animations[0]).play(); // Idle animation
          }

          // Animation loop
          function animate() {
            requestAnimationFrame(animate);
            if (mixer) mixer.update(0.01);
            renderer.render(scene, camera);
          }
          animate();
        },
        (progress) => console.log(`Model: ${Math.round(progress.loaded / progress.total * 100)}%`),
        (error) => {
          console.error("Failed to load model", error);
          alert("3D model failed to load. Check your internet or file path.");
        }
      );
    });

    // === ‚úÖ GLOBAL diagnose FUNCTION ===
    window.diagnose = function() {
      const make = document.getElementById("make").value.trim();
      const model = document.getElementById("model").value.trim();
      const year = document.getElementById("year").value.trim();
      const symptom = document.getElementById("symptom").value.trim().toLowerCase();

      if (!make || !model || !year || !symptom) {
        alert("Fill in all the details, guv'nor!");
        return;
      }

      // Realistic causes
      const causesList = {
        "brake": ["üõë Low brake fluid", "üîß Worn pads", "üíß Leaking line", "‚öôÔ∏è Master cylinder", "üìØ ABS fault"],
        "start": ["üîã Dead battery", "‚öôÔ∏è Starter motor", "‚õΩ Fuel pump", "üîë Immobilizer", "üîå Loose terminals"],
        "noise": ["üîä Engine knock", "üéµ Bearing whine", "üß® Exhaust leak", "üí¢ Timing rattle", "ü™õ Loose shield"],
        "default": ["üîå Scan OBD2", "üîã Test battery", "üß∞ Inspect parts", "üõ¢Ô∏è Check fluids", "üßπ Clean throttle"]
      };

      let causes = causesList.default;
      for (let key in causesList) {
        if (symptom.includes(key)) {
          causes = causesList[key];
          break;
        }
      }

      document.getElementById("causes").innerHTML = causes.map(c => `<li>${c}</li>`).join("");

      const query = encodeURIComponent(`${make} ${model} ${year} ${symptom} fix`);
      document.getElementById("video-link").href = `https://www.youtube.com/results?search_query=${query}`;

      const partQuery = encodeURIComponent(`${make} ${model} ${symptom} car part`);
      document.getElementById("amazon-link").href = `https://www.amazon.co.uk/s?k=${partQuery}`;
      document.getElementById("ebay-link").href = `https://www.ebay.co.uk/sch/i.html?_nkw=${partQuery}`;

      document.getElementById("results").style.display = "block";

      // Optional: Voice
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(
          `Right, your ${make} ${model}? Could be the ${causes[0]}. Check it now, guv'nor!`
        );
        utterance.rate = 0.9;
        utterance.pitch = 0.7;
        window.speechSynthesis.speak(utterance);
      }
    };
  </script>
</body>
</html>
